<launch>
  <!-- Args so you can tweak without editing the file -->
  <arg name="scan"         default="/scan"/>
  <arg name="map_frame"    default="map"/>
  <arg name="odom_frame"   default="odom"/>            <!-- Must match RL world_frame -->
  <arg name="base_frame"   default="base_footprint"/>  <!-- Must match RL base_link_frame -->
  <arg name="resolution"   default="0.05"/>            <!-- 0.05m is robust; 0.025 can be noisy/heavy -->
  <arg name="update_sec"   default="1.5"/>             <!-- Map publish period -->

  <node pkg="slam_karto" type="slam_karto" name="slam_karto" output="screen">

    <!-- Frame wiring -->
    <param name="map_frame"  value="$(arg map_frame)"/>
    <param name="odom_frame" value="$(arg odom_frame)"/>
    <param name="base_frame" value="$(arg base_frame)"/>

    <!-- Map resolution & update -->
    <param name="resolution"           value="$(arg resolution)"/>
    <param name="map_update_interval"  value="$(arg update_sec)"/>

    <!-- Make small-FOV + occlusion workable -->
    <param name="use_scan_matching"        value="true"/>
    <param name="use_scan_barycenter"      value="true"/>
    <param name="minimum_travel_distance"  value="0.05"/>   <!-- trigger integration sooner -->
    <param name="minimum_travel_heading"   value="0.05"/>   <!-- ~3 degrees -->

    <!-- Sensor range (set to your lidar range if different) -->
    <param name="range_threshold" value="25.0"/>

    <!-- Search window: tighter XY, fine grid for 2D indoor -->
    <param name="correlation_search_space_dimension"  value="0.6"/>   <!-- +/-0.3 m -->
    <param name="correlation_search_space_resolution" value="0.02"/>  <!-- 2 cm -->
    <param name="correlation_search_space_smear_deviation" value="0.1"/>

    <!-- Penalties keep matches sane when data is partial -->
    <param name="distance_variance_penalty" value="0.5"/>
    <param name="angle_variance_penalty"    value="0.8"/>

    <!-- Loop closure more permissive for small FOV -->
    <param name="loop_search_maximum_distance" value="8.0"/>
    <param name="loop_search_maximum_angle"    value="1.2"/>  <!-- ~69° -->

    <!-- Loop/link thresholds (balanced) -->
    <param name="link_match_minimum_response"        value="0.7"/>
    <param name="loop_match_minimum_chain_size"      value="10"/>
    <param name="loop_match_maximum_variance_coarse" value="3.0"/>
    <param name="loop_match_minimum_response_coarse" value="0.6"/>
    <param name="loop_match_minimum_response_fine"   value="0.65"/>

    <!-- Angular search steps -->
    <param name="coarse_search_angle_offset" value="0.35"/>  <!-- ≈20° -->
    <param name="coarse_angle_resolution"    value="0.02"/>  <!-- ≈1.1° -->
    <param name="fine_search_angle_offset"   value="0.05"/>  <!-- ≈3° -->

    <!-- Throughput helpers -->
    <param name="throttle_scans" value="1"/>           <!-- keep all scans; raise to 2 if CPU rises -->
    <param name="use_response_expansion" value="true"/>

    <!-- Topic wiring -->
    <remap from="scan" to="$(arg scan)"/>
  </node>
</launch>
